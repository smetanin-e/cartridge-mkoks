generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Model {
    id         Int         @id @default(autoincrement())
    model      String      @unique
    cartridges Cartridge[] // 1 → many

    printers Printer[]
}

model Cartridge {
    id            Int    @id @default(autoincrement())
    number        String @unique // Уникальный номер картриджа (например, МК101)
    numericNumber Int //Уникальный номер картриджа без МК для сортировки

    modelId Int
    model   Model @relation(fields: [modelId], references: [id]) // many → 1

    status CartridgeStatus @default(AVAILABLE)

    // Связи с записями о заменах
    replacementInstalled Replacement[] @relation("InstalledCartridge")
    replacementRemoved   Replacement[] @relation("RemovedCartridge")

    // Связи с партиями отправки в сервис (через промежуточную таблицу)
    serviceBatchEntries ServiceBatchCartridge[]
}

enum CartridgeStatus {
    SERVICE // В сервисе
    WORKING // В работе
    RESERVE // Сняты с обслуживания
    AVAILABLE // Готовы к использованию
    REFILL // Требуется заправка
}

model Printer {
    id     Int     @id @default(autoincrement())
    name   String
    models Model[]
}

model Departament {
    id   Int    @id @default(autoincrement())
    name String

    replacements Replacement[]
}

enum BatchStatus {
    in_progress // В стадии заправки (отправлена в сервис)
    completed // Выполнено (все картриджи вернулись)
    partial_return // Частичный возврат (некоторые картриджи вернулись)
}

model Replacement {
    id   Int    @id @default(autoincrement())
    date String

    departament   Departament @relation(fields: [departamentId], references: [id])
    departamentId Int

    installedCartridgeNumber String? // Номер установленного картриджа
    removedCartridgeNumber   String? // Номер снятого картриджа
    responsible              String // Ответственный за исполнение
    createdAt                DateTime @default(now())

    installedCartridge Cartridge? @relation("InstalledCartridge", fields: [installedCartridgeNumber], references: [number])
    removedCartridge   Cartridge? @relation("RemovedCartridge", fields: [removedCartridgeNumber], references: [number])
}

// Модель для партий отправки картриджей в сервис
model ServiceBatch {
    id          String      @id @default(cuid())
    batchNumber String      @unique // Уникальный номер партии
    date        DateTime    @db.Date // Дата отправки в сервис
    responsible String // Ответственный за отправку
    notes       String? // Примечания
    createdAt   DateTime    @default(now())
    status      BatchStatus @default(in_progress) // Статус партии (в работе, выполнено, частичный возврат)

    // Связь с картриджами, входящими в эту партию (через промежуточную таблицу)
    cartridgesInBatch ServiceBatchCartridge[]
}

// Промежуточная модель для связи Cartridge и ServiceBatch
// Позволяет отслеживать статус возврата каждого картриджа в рамках конкретной партии
model ServiceBatchCartridge {
    id             String @id @default(cuid())
    cartridgeId    Int
    serviceBatchId String

    cartridge    Cartridge    @relation(fields: [cartridgeId], references: [id])
    serviceBatch ServiceBatch @relation(fields: [serviceBatchId], references: [id])

    returned          Boolean   @default(false) // Был ли этот конкретный картридж возвращен
    returnDate        DateTime? @db.Date // Дата возврата этого конкретного картриджа
    returnResponsible String? // Ответственный за прием этого конкретного картриджа
    returnNotes       String? // Примечания к возврату этого конкретного картриджа

    @@unique([cartridgeId, serviceBatchId]) // Картридж может быть в одной партии только один раз
}
